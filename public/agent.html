<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Agent Sim</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
      #toggleButton {
      	position: absolute;
      	top: 20px;
      	left: 300px;
      	height: 30px;
      	width: 150px;
      }
      #infoArea {
        position: absolute;
        top: 200px;
        left: 50px;
      }
      #agentEnabled {
        position: absolute;
        top: 500px;
        left: 20px;
      }
      #paxos {
        position: absolute;
        top: 30px;
        left: 50%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="infoArea"></div>
    <div id="paxos">
      <input type="text" name="paxosVal"><input type="button" id="sendValue"/><br />
      <p id="paxosDebug">
        not started
      </p>
    </div>
    <div id="agentEnabled">
      <input type="button" id="toggleAgent" onclick="toggleAgent()" value="Enabled?"></input>
    </div>
    <script type="text/javascript" src="httpCalls.js"></script>
    <script type="text/javascript" src="agent.js"></script>
    <script type="text/javascript" src="map.js"></script>
    <script>

        var maxRound = 0;
        var proposedValue = "";
        var numAgents = -1;
        var quorumSize = (numAgents / 2) - 1;
        var prevAcceptedRound = -1;
        var prevAcceptedValue = "";

        function handleMessage(message) {
          var part = message.split(' ');
          if (part[0] == 'prepare') {
            if (part.length > 1) {
              handlePrepare(part[1]);
            }
          } else if (part[0] == 'promise') {
            console.log("got promise result!");
          } else if (part[0] == 'accept') {
            console.log('got accept request!')
          } else if (part[0] == 'accepted') {
            console.log('got accepted result!');
          } else if (part[0] == 'nack_promise') {
            console.log('NACK!!! failed to promise!');
          } else {  //broken message!
            console.log('incorrect message format! ' + s);
          }
        }

        //Local agent uses this to initiate a paxos round
        function requestPaxos(proposedValue) {
          var roundNo = maxRound * 100 + agent.id;  //Incorporating agent id as lower order digits 
          httpGetAsync('/agents/broadcast/' + agent.id + '/prepare ' + roundNo, function(res) {
            console.log('sent prepare to ' + res);
          });
          maxRound++;
        }

        function handlePrepare(roundNumber) {
          console.log("got prepare request!");
          var response = '';
          if (roundNumber > maxRound) {
            maxRound == roundNumber / 100;
            response = 'promise ' + prevAcceptedRound + ' ' + prevAcceptedValue;
          } else {
            response = 'nack';  //SHOULD WE NACK!!! //TODO
          }
          httpGetAsync('/agents/broadcast/' + agent.id + '/' + response, function(res) {
            console.log('sent promise to ' + res);
          });
        }

        function handlePromise(lastRoundNumber, lastRoundValue) { 
          console.log('got promise from ')
        }
        
        function handleAccept();
        
        function handleAccepted();




        /*****Code to initalize agent START *****/

        var bounds = {x1: 43.132, y1: -76.282, x2: 42.988, y2: -76.047};

        function randomWaypoint (bounds) {
            var xDelta = Math.abs(bounds.x1 - bounds.x2);
            var yDelta = Math.abs(bounds.y1 - bounds.y2);
            var xRandom = Math.min(bounds.x1, bounds.x2) + Math.random() * xDelta;
            var yRandom = Math.min(bounds.y1, bounds.y2) + Math.random() * yDelta;
            return {x:xRandom, y:yRandom};
        }
        
        var waypoints = [];
        for (var i = 0; i < 10; i++) {
            var waypt = randomWaypoint(bounds);
            waypoints.push({lat:waypt.x, lng:waypt.y});
        }
        
        var centerLatLong = waypoints[0];

        var agentInit = httpGet('/agents/initialize/' + waypoints[0].lat + '/' + waypoints[0].lng);
        var agentInitJSON = JSON.parse(agentInit);
        var id = agentInitJSON.id;
        
        var agent = new Agent(id, "#00F", waypoints, 200, false);

        /*****Code to intiialize agent END*****/

        function toggleAgent() {
            agent.enabled = !agent.enabled;
        }

        var positionUpdateFreq = 300;
        var comsFreq = 5000;
        var statusUpdateFreq = 500;
        var scanFreq = 1000;
        var checkMailFreq = 400;

        var otherAgents = [];
        var collects = [];
        var messages = [];

        this.interval2 = setInterval(function() {
            if (agent.enabled) {
                httpGetAsync('/agents/updateLoc/' + agent.id + '/' + agent.currentPos.lat + '/' + agent.currentPos.lng, function(){;});
            }
        }, positionUpdateFreq);
        
        this.interval3 = setInterval(function() {
            if (agent.enabled) {
                httpGetAsync('/agents/status/', function(res){
                    otherAgents = JSON.parse(res);
                    numAgents = otherAgents.length;
                    var myIdx = otherAgents.findIndex((x) => x.id == agent.id);
                    otherAgents.splice(myIdx, 1);
                });
            }
        }, statusUpdateFreq)
                
        this.interval4 = setInterval(function() {
            if (agent.enabled) {
                httpGetAsync('/agents/broadcast/' + agent.id + '/hi from ' + agent.id, function(res) {
                  console.log('sent message to ' + res);
                });
                /*
                if (otherAgents.length > 0) {
                  var toAgent = otherAgents[Math.floor(Math.random() * otherAgents.length)].id;
                  httpGetAsync('/agents/communicate/' + agent.id + '/' + toAgent + '/hello', function(){;});
                }
                */
            }
        }, comsFreq);

        this.interval5 = setInterval(function() {
          if (agent.enabled) {
            httpGetAsync('/collects/show/', function(res){
              collects = JSON.parse(res);
              updateCollects();
            });
          }
        }, scanFreq);

        this.interval6 = setInterval(function() {
          if(agent.enabled) {
            httpGetAsync('/agents/getMessages/' + agent.id + '/flush', function(res) {
              messages = JSON.parse(res);
              messages.forEach(handleMessage);
            })
          }
        }, checkMailFreq);

        window.addEventListener("beforeunload", function(e){
          httpGetAsync('/agents/remove/' + agent.id, function(res) {
            console.log('bye');
          });
        }, false);

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDf85AQTumVMvli31zD4DkgPVc3C06YZtw&callback=initMap&signed_in=true&libraries=geometry" async defer>
    </script>
  </body>
</html>